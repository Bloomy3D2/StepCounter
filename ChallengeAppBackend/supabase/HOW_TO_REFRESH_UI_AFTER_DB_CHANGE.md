# Как обновить UI после изменения данных в БД

## Шаг 1: Удаление участия в БД

1. Откройте **Supabase Dashboard** → **SQL Editor**
2. Выполните SQL скрипт из файла `remove-user-participation.sql`
3. Выберите нужный вариант (удалить все участия или конкретное)
4. Замените `USER_ID_HERE` на ваш UUID пользователя
5. Нажмите **Run** для выполнения

## Шаг 2: Обновление данных в приложении

После изменения данных в БД, в приложении остаются **кэшированные данные**. Нужно их обновить.

### Способ 1: Через кнопку "Сбросить локальные данные" (РЕКОМЕНДУЕТСЯ)

1. Откройте приложение
2. Перейдите в **Профиль** (иконка профиля в правом верхнем углу)
3. Нажмите кнопку **"Сбросить локальные данные"**
4. Подтвердите действие
5. Приложение автоматически:
   - Удалит все локальные данные
   - Очистит кэш
   - Загрузит свежие данные с сервера
   - Обновит UI

### Способ 2: Pull-to-Refresh (если кэш не мешает)

1. Откройте экран **"Челленджи"** или **"Мой прогресс"**
2. Потяните экран вниз (pull-to-refresh)
3. Данные обновятся с сервера

**⚠️ ВНИМАНИЕ:** Если кэш еще не истек (TTL = 5 минут), pull-to-refresh может не загрузить новые данные. В этом случае используйте **Способ 1**.

### Способ 3: Перезапуск приложения (если кэш истек)

1. Полностью закройте приложение (swipe up в App Switcher)
2. Подождите 5+ минут (чтобы истек TTL кэша)
3. Откройте приложение заново
4. Данные загрузятся с сервера

**⚠️ ВНИМАНИЕ:** Этот способ не гарантирует обновление, если кэш еще активен.

## Шаг 3: Проверка результата

После обновления данных проверьте:

1. **Экран "Челленджи"**:
   - Кнопки "Вступить" должны быть активны
   - Не должно быть сообщений "Вы участвуете"

2. **Экран "Мой прогресс"**:
   - Список должен быть пустым (если удалили все участия)
   - Или не должно быть удаленного челленджа

3. **Экран "Профиль"**:
   - Баланс должен быть актуальным

## Технические детали

### Как работает кэширование

- **TTL кэша:** 5 минут (300 секунд)
- **Хранение:** 
  - В памяти (NSCache) - быстрый доступ
  - В UserDefaults - для офлайн режима

### Функция `clearLocalData()`

Эта функция (вызывается кнопкой "Сбросить локальные данные") делает:

```swift
1. Удаляет данные из UserDefaults
2. Очищает NSCache
3. Очищает локальные переменные (availableChallenges, userChallenges)
4. Вызывает syncWithSupabase() - загружает свежие данные с сервера
5. Обновляет UI автоматически
```

### Функция `syncWithSupabase()`

```swift
1. Загружает challenges из Supabase
2. Загружает user_challenges из Supabase
3. Обновляет кэш
4. Обновляет UI через @Published свойства
```

## Если данные не обновились

1. **Проверьте подключение к интернету**
2. **Проверьте, что SQL скрипт выполнился успешно:**
   ```sql
   SELECT * FROM public.user_challenges WHERE user_id = 'YOUR_USER_ID';
   ```
   Должно вернуть 0 строк (если удалили все)

3. **Проверьте логи в Xcode Console:**
   - Должны быть сообщения "Loading challenges from server"
   - Не должно быть ошибок сети

4. **Используйте кнопку "Сбросить локальные данные"** - это самый надежный способ

## Быстрая справка

| Действие | Команда |
|----------|---------|
| Удалить все участия | SQL: `DELETE FROM user_challenges WHERE user_id = 'UUID'` |
| Обновить UI | Кнопка "Сбросить локальные данные" в Профиле |
| Проверить БД | SQL: `SELECT * FROM user_challenges WHERE user_id = 'UUID'` |
| Найти UUID по email | SQL: `SELECT id FROM users WHERE email = 'email@example.com'` |
