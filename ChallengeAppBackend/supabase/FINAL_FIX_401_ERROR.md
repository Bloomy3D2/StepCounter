# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: 401 –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ —á–µ–ª–ª–µ–Ω–¥–∂–∞

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

Edge Function `fail-challenge` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **401 (Unauthorized)**, –ø–æ—ç—Ç–æ–º—É:
1. SQL —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. –î–∞–Ω–Ω—ã–µ –≤ –ë–î –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
3. –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
4. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π

**–í –ª–æ–≥–∞—Ö:**
```
‚ùå failChallenge: Edge Function FAILED - Error: Edge Function returned a non-2xx status code: 401
```

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è UPDATE –∏ INSERT (–ö–†–ò–¢–ò–ß–ù–û!)

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ `FIX_RLS_POLICIES.sql` –≤ Supabase SQL Editor:**

```sql
-- –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è INSERT
CREATE POLICY "Users can insert own challenges"
    ON public.user_challenges FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è UPDATE
CREATE POLICY "Users can update own challenges"
    ON public.user_challenges FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã:**
```sql
SELECT 
    policyname,
    cmd,
    qual,
    with_check
FROM pg_policies
WHERE tablename = 'user_challenges'
ORDER BY cmd, policyname;
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 3 –ø–æ–ª–∏—Ç–∏–∫–∏:**
- `Users can view own challenges` (SELECT)
- `Users can insert own challenges` (INSERT) ‚Üê **–ù–û–í–ê–Ø**
- `Users can update own challenges` (UPDATE) ‚Üê **–ù–û–í–ê–Ø**

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Edge Function

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard:
- –ó–∞–π–¥–∏—Ç–µ –≤ **Dashboard ‚Üí Edge Functions ‚Üí fail-challenge ‚Üí Logs**
- –ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ (—É—Å–ø–µ—à–Ω—ã–π —Å–ª—É—á–∞–π):**
```
üìã Request headers: { ... }
üîë Authorization header: Bearer eyJhbGciOiJIUzI1...
‚úÖ User authenticated: 92689F5E-8F4B-4BE4-845E-0ED7EC75FEF8
üì• Fail challenge request: userId=..., challengeId=...
üìã User challenge BEFORE fail: { is_active: true, is_failed: false }
‚úÖ fail_challenge RPC success: { success: true, rows_updated: 1 }
üìã User challenge AFTER fail: { is_active: false, is_failed: true }
‚úÖ Verified: Challenge correctly marked as failed
```

**–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ 401:**
```
üîë Authorization header: MISSING
‚ùå No authorization header provided
```
–∏–ª–∏
```
üîë Authorization header: Bearer ...
‚ùå getUser() error: ...
‚ùå Unauthorized - user not found or error occurred
```

### –®–∞–≥ 3: –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–æ–º

–ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö Edge Function –≤–∏–¥–Ω–æ "Authorization header: MISSING", –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ø–µ—Ä–µ–¥–∞—á–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –°–µ—Å—Å–∏—è –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ (–∫–æ–¥ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é)
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "Session found for user: ...")

### –®–∞–≥ 4: –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å RLS

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –Ω–æ –≤—Å–µ –µ—â–µ 401, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏:
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã (–®–∞–≥ 1)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è UPDATE –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å `is_failed` –∏ `is_active`

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–ª–∞ (–∫–æ–≥–¥–∞ Edge Function –≤–µ—Ä–Ω–µ—Ç 200):
```sql
SELECT id, challenge_id, is_active, is_completed, is_failed, failed_at
FROM public.user_challenges
WHERE id = 24;  -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π id
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- `is_failed = true`
- `is_active = false`
- `failed_at` –Ω–µ NULL

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ï—Å–ª–∏ Edge Function –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function:**
   - –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Authorization header"?
   - –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "getUser() error"?

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏:**
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ –®–∞–≥–∞ 1
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Å—Å–∏—é –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
   - –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "Session found for user: ..."
   - –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "Session isExpired: false"

### –ï—Å–ª–∏ Edge Function –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function:**
   - –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "User challenge AFTER fail"?
   - –ï—Å—Ç—å –ª–∏ "CRITICAL: fail_challenge did not update correctly"?

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ SQL —Ñ—É–Ω–∫—Ü–∏—é:**
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –≤—ã–∑–æ–≤ –≤—Ä—É—á–Ω—É—é:
   ```sql
   SELECT public.fail_challenge(
       '92689F5E-8F4B-4BE4-845E-0ED7EC75FEF8'::UUID,
       3::BIGINT
   );
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:**
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ –®–∞–≥–∞ 5

---

## üìù –ß–¢–û –ò–ó–ú–ï–ù–ò–õ–û–°–¨

### –í Swift –∫–æ–¥–µ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º Edge Function
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (accessToken, expiresAt, isExpired)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –¥–µ—Ç–∞–ª–µ–π –∏–∑ response

### –í Edge Function:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Authorization header (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ getUser()
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Supabase client

### –í SQL:
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `fail_challenge` (—É–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `is_active = true`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è INSERT –∏ UPDATE (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é!)

---

## üß™ –ü–†–û–í–ï–†–ö–ê

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **–ü—Ä–æ–≤–∞–ª–∏—Ç–µ —á–µ–ª–ª–µ–Ω–¥–∂** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "‚úÖ User authenticated" –∏ "‚úÖ Verified: Challenge correctly marked as failed"
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `is_failed = true, is_active = false`
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é** - –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂
5. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-23  
**–°—Ç–∞—Ç—É—Å:** üö® –°–†–û–ß–ù–û - –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–í–ê–ñ–ù–û:** –ë–µ–∑ RLS –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è UPDATE Edge Function –Ω–µ —Å–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
