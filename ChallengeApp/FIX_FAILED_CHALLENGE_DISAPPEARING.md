# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏—Å—á–µ–∑–∞—é—â–∏–º–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–º–∏ —á–µ–ª–ª–µ–Ω–¥–∂–∞–º–∏

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞:
1. ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (`isFailed=true, isActive=false`)
2. ‚úÖ –í –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. ‚ùå –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
4. ‚ùå –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É –∏ –æ–±—Ä–∞—Ç–Ω–æ –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–∞–ª–æ–≤ –∏—Å—á–µ–∑–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–∞–∫ `isActive=true, isFailed=false` –≤–º–µ—Å—Ç–æ `isActive=false, isFailed=true`.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏—é `fail_challenge`

SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å:
```sql
UPDATE public.user_challenges
SET is_failed = true,
    is_active = false,
    failed_at = NOW(),
    updated_at = NOW()
WHERE id = v_user_challenge.id;
```

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤ Supabase SQL Editor:

```sql
-- –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —á–µ–ª–ª–µ–Ω–¥–∂–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–º–∏
UPDATE public.user_challenges
SET is_failed = true,
    is_active = false,
    failed_at = COALESCE(failed_at, updated_at, NOW())
WHERE is_active = false 
  AND is_completed = false 
  AND is_failed = false
  AND failed_at IS NULL;
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç—å Edge Function

Edge Function —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –ü–µ—Ä–µ–¥–µ–ø–ª–æ–π—Ç–µ:

```bash
cd ChallengeAppBackend/supabase
supabase functions deploy fail-challenge
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –≤ –ª–æ–≥–∞—Ö Edge Function –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
üì• Fail challenge request: userId=..., challengeId=...
üìã User challenge BEFORE fail: { is_active: true, is_failed: false }
‚úÖ fail_challenge RPC success: { success: true }
üìã User challenge AFTER fail: { is_active: false, is_failed: true }
```

–ï—Å–ª–∏ `AFTER fail` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∑–Ω–∞—á–∏—Ç SQL —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

---

## üîç –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –í Swift –∫–æ–¥–µ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–ª–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, –∑–∞—Ç–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞

### –í Edge Function:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ SQL —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `user_challenge` –¥–æ –∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –í SQL:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `fail_challenge` –¥–æ–ª–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `is_failed=true, is_active=false`

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–∞–ª–∏—Ç–µ —á–µ–ª–ª–µ–Ω–¥–∂** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é** - –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂
3. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
4. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É –∏ –æ–±—Ä–∞—Ç–Ω–æ** - –∏—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- `üìã User challenge AFTER fail: { is_active: false, is_failed: true }` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- `üîç SupabaseManager.getUserChallenges: Raw response - ... isFailed=true` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è, –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:
- –¢–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `isActive`, `isFailed` –¥–æ –∏ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ SQL —Ñ—É–Ω–∫—Ü–∏–∏
- –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ö—ç—à:** –ü–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, –∑–∞—Ç–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
