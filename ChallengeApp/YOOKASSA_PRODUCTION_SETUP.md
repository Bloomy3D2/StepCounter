# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## ‚úÖ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ–¥–µ:**
- ‚úÖ `YooKassaClient.swift` - –∫–ª–∏–µ–Ω—Ç API –ÆKassa
- ‚úÖ `PaymentManager.swift` - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ `PaymentView.swift` - UI –¥–ª—è –æ–ø–ª–∞—Ç—ã
- ‚úÖ Edge Function `payment-webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`onOpenURL`)
- ‚úÖ –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –°–ë–ü, –∫–∞—Ä—Ç, Apple Pay
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**‚ö†Ô∏è –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–µ–π –∏ webhook URL.**

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### 1. **–ö–ª—é—á–∏ –æ—Ç –ÆKassa** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ [–ÆKassa](https://yookassa.ru) –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å:

#### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
- **`shopId`** - ID –º–∞–≥–∞–∑–∏–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `123456`)
- **`secretKey`** - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: `live_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`)

#### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- **`testShopId`** - ID —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
- **`testSecretKey`** - –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `test_`)

**–ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å:**
1. –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/my)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **"–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–ö–ª—é—á–∏ API"**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `shopId` –∏ `secretKey`

---

### 2. **URL –≤–∞—à–µ–≥–æ Supabase –ø—Ä–æ–µ–∫—Ç–∞** (–¥–ª—è webhook)

–ù—É–∂–µ–Ω URL –≤–∞—à–µ–≥–æ Supabase –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook'–æ–≤.

**–§–æ—Ä–º–∞—Ç:** `https://YOUR_PROJECT.supabase.co`

**–ì–¥–µ –Ω–∞–π—Ç–∏:**
- –í –ø–∞–Ω–µ–ª–∏ Supabase: **Settings ‚Üí API ‚Üí Project URL**

**Webhook URL –±—É–¥–µ—Ç:** `https://YOUR_PROJECT.supabase.co/functions/v1/payment-webhook`

---

## üîß –ß—Ç–æ —è —Å–¥–µ–ª–∞—é –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ –ø—Ä–æ–µ–∫—Ç

–Ø –¥–æ–±–∞–≤–ª—é –∫–ª—é—á–∏ –≤ `Info.plist` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è iOS):

```xml
<key>YOOKASSA_SHOP_ID</key>
<string>–í–ê–®_SHOP_ID</string>

<key>YOOKASSA_SECRET_KEY</key>
<string>–í–ê–®_SECRET_KEY</string>

<key>YOOKASSA_TEST_MODE</key>
<false/>
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ (–¥–ª—è CI/CD).

---

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ –ÆKassa

**–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç:**
1. –í–æ–π—Ç–∏ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/my)
2. –ü–µ—Ä–µ–π—Ç–∏: **"–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"**
3. –î–æ–±–∞–≤–∏—Ç—å URL: `https://YOUR_PROJECT.supabase.co/functions/v1/payment-webhook`
4. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - ‚úÖ `payment.canceled` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
   - ‚ö†Ô∏è `payment.waiting_for_capture` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ò–ª–∏ —è –º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ API.**

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ URL Scheme

–ü—Ä–æ–≤–µ—Ä—é, —á—Ç–æ –≤ `Info.plist` –Ω–∞—Å—Ç—Ä–æ–µ–Ω URL scheme –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>challengeapp</string>
        </array>
    </dict>
</array>
```

---

### –®–∞–≥ 4: –î–µ–ø–ª–æ–π Edge Function

–£–±–µ–¥–∏–º—Å—è, —á—Ç–æ Edge Function `payment-webhook` –∑–∞–¥–µ–ø–ª–æ–µ–Ω–∞:

```bash
cd ChallengeAppBackend/supabase
supabase functions deploy payment-webhook
```

---

## üìù –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

**–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–ª–µ–¥—É—é—â–µ–µ:**

```
=== –ÆKassa –∫–ª—é—á–∏ ===
Shop ID: 123456
Secret Key: live_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

=== Supabase ===
Project URL: https://xxxxx.supabase.co

=== –†–µ–∂–∏–º ===
[ ] –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (test_ –∫–ª—é—á–∏)
[x] –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º (live_ –∫–ª—é—á–∏)
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** 
- –ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–ª—é—á–∏ –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
- –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π –≤ `Info.plist` –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª –≤ `.gitignore` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

### 1. –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞)

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (`test_` –ø—Ä–µ—Ñ–∏–∫—Å)
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `YOOKASSA_TEST_MODE = true` –≤ `Info.plist`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏:
   - –£—Å–ø–µ—à–Ω–∞—è: `5555 5555 5555 4444`
   - –û—Ç–º–µ–Ω–∞: `5555 5555 5555 4477`

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function –≤ Supabase Dashboard
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. –°–æ–≤–µ—Ä—à–∏—Ç–µ –ø–ª–∞—Ç–µ–∂
2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —á–µ–ª–ª–µ–Ω–¥–∂ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç (–Ω–µ —Ö—Ä–∞–Ω–∏–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook'–æ–≤ (HMAC-SHA256)
- –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –Ω–µ –≤ –∫–æ–¥–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `AppConfig`)

### ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ –≤ `Info.plist` (–Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ git)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard (Edge Functions)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–Ω–µ localhost)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] –ü–æ–ª—É—á–µ–Ω—ã –∫–ª—é—á–∏ –æ—Ç –ÆKassa (shopId, secretKey)
- [ ] –ö–ª—é—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `Info.plist` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
- [ ] Edge Function `payment-webhook` –∑–∞–¥–µ–ø–ª–æ–µ–Ω–∞
- [ ] URL scheme `challengeapp://` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `Info.plist`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

---

## üéØ –ò—Ç–æ–≥–æ

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –Ω–∞ 100%.** 

–î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ:
1. ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á–∏ –æ—Ç –ÆKassa
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –ø—Ä–æ–µ–∫—Ç (—è —Å–¥–µ–ª–∞—é)
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

**–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ~15-30 –º–∏–Ω—É—Ç** (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–µ–π)
