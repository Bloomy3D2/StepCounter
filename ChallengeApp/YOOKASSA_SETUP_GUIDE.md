# –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω `YooKassaClient` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –ÆKassa
2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `PaymentManager` —Å —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
3. ‚úÖ –°–æ–∑–¥–∞–Ω Edge Function `payment-webhook` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤
4. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL scheme –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤–∞–º

### –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [yookassa.ru](https://yookassa.ru)
2. –ü—Ä–æ–π–¥–∏—Ç–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é (–Ω—É–∂–µ–Ω –ò–ü/–û–û–û)
3. –ü–æ–ª—É—á–∏—Ç–µ:
   - **shopId** (ID –º–∞–≥–∞–∑–∏–Ω–∞)
   - **secretKey** (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á)
   - **testKey** (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–µ–π

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Secrets (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard: https://supabase.com/dashboard/project/qvyxkbeafgarcjjppttd
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **Edge Functions** ‚Üí **Secrets**
3. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã:
   - `YOOKASSA_SHOP_ID` = –≤–∞—à shopId
   - `YOOKASSA_SECRET_KEY` = –≤–∞—à secretKey

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –í –∫–æ–¥–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

–û—Ç–∫—Ä–æ–π—Ç–µ `YooKassaClient.swift` –∏ –∑–∞–º–µ–Ω–∏—Ç–µ:

```swift
self.shopId = shopId ?? "YOUR_SHOP_ID" // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
self.secretKey = secretKey ?? "YOUR_SECRET_KEY" // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
```

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –≤ Git!

### –®–∞–≥ 3: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Edge Function

```bash
cd /Users/maratgaliev/Downloads/Project/MyProjectGame/ChallengeAppBackend/supabase

# –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å webhook
supabase functions deploy payment-webhook --no-verify-jwt
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Dashboard:
1. Supabase Dashboard ‚Üí Edge Functions
2. Create a new function
3. Name: `payment-webhook`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ `edge-functions/payment-webhook/index.ts`
5. Deploy

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook URL –≤ –ÆKassa

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
3. –£–∫–∞–∂–∏—Ç–µ URL: `https://qvyxkbeafgarcjjppttd.supabase.co/functions/v1/payment-webhook`
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded`
   - ‚úÖ `payment.canceled`
   - ‚úÖ `payment.waiting_for_capture`

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ URL Scheme –≤ Xcode

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Xcode
2. –í—ã–±–µ—Ä–∏—Ç–µ target **ChallengeApp**
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Info** ‚Üí **URL Types**
4. –ù–∞–∂–º–∏—Ç–µ **+** –∏ –¥–æ–±–∞–≤—å—Ç–µ:
   - **Identifier**: `com.challengeapp.payment`
   - **URL Schemes**: `challengeapp`

–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `Info.plist` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLName</key>
        <string>com.challengeapp.payment</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>challengeapp</string>
        </array>
    </dict>
</array>
```

### –®–∞–≥ 6: –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

–í –∫–æ–¥–µ –µ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:

```swift
// –í PaymentManager.swift
var useRealPayments: Bool {
    return UserDefaults.standard.bool(forKey: "useRealPayments")
}
```

–í–∫–ª—é—á–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–¥ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```swift
UserDefaults.standard.set(true, forKey: "useRealPayments")
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –ÆKassa

- **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: `5555 5555 5555 4444`
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞**: `5555 5555 5555 4477`
- **3D Secure**: `5555 5555 5555 4444` (—Å CVV `123`)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook'–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard ‚Üí Edge Functions ‚Üí payment-webhook ‚Üí Logs
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç—É–ø–∏–ª –≤ —á–µ–ª–ª–µ–Ω–¥–∂

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç (–Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook'–æ–≤ (–≤ Edge Function)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Service Role Key –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –≤ webhook'–µ

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- [ ] –ö–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase Secrets (–Ω–µ –≤ –∫–æ–¥–µ)
- [ ] Webhook URL –∑–∞—â–∏—â–µ–Ω –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏
- [ ] –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ —Å–∏–º—É–ª—è—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–∞

### –ü–æ—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –í—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–°–ë–ü)
2. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ `YooKassaClient.createPayment()`
3. **–ÆKassa** ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (3D Secure –∏–ª–∏ –°–ë–ü)
4. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç URL –≤ Safari
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É
6. **–ÆKassa** ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –≤ Supabase
7. **Edge Function** ‚Üí –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook, –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —á–µ–ª–ª–µ–Ω–¥–∂
8. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí –ü–æ–ª—É—á–∞–µ—Ç callback —á–µ—Ä–µ–∑ URL scheme

### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

–ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —á–µ–ª–ª–µ–Ω–¥–∂ –Ω–µ —É–¥–∞–ª–æ—Å—å:

1. **Edge Function** ‚Üí –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
2. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç `paymentManager.refundPayment()`
3. **–ÆKassa** ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞—Ç–µ–∂ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å shopId –∏ secretKey
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –ÆKassa
- –õ–æ–≥–∏ –≤ Xcode Console

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- URL webhook –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ÆKassa
- –õ–æ–≥–∏ Edge Function –≤ Supabase Dashboard
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã)

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —á–µ–ª–ª–µ–Ω–¥–∂

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –õ–æ–≥–∏ Edge Function
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å metadata (challenge_id, user_id)
- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆKassa API](https://yookassa.ru/developers/api)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [Webhook'–∏](https://yookassa.ru/developers/using-api/webhooks)

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

- [ ] –ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –æ—Ç –ÆKassa
- [ ] –ö–ª—é—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Supabase Secrets
- [ ] Edge Function —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa
- [ ] URL scheme –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Xcode
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞, –°–ë–ü)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- [ ] –û—Ç–∫–ª—é—á–µ–Ω–∞ —Å–∏–º—É–ª—è—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∫–ª—é—á–∏ –Ω–µ –≤ –∫–æ–¥–µ)

---

**–ì–æ—Ç–æ–≤–æ!** –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø–ª–∞—Ç–µ–∂–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. üöÄ
