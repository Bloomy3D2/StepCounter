# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä—è–º–æ–π –æ–ø–ª–∞—Ç—ã –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏

## –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–ø—Ä—è–º–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ —á–µ–ª–ª–µ–Ω–¥–∂** –≤–º–µ—Å—Ç–æ —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–∞–Ω—Å–∞.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

1. ‚úÖ **PaymentView** - –æ–±–Ω–æ–≤–ª–µ–Ω —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã:
   - –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (Apple Pay / –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞)
   - –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ
   - –ü–æ–∫–∞–∑ –ø—Ä–∞–≤–∏–ª
   - –ü—Ä—è–º–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏

2. ‚úÖ **PaymentManager** - –æ–±–Ω–æ–≤–ª–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π:
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
   - –°–∏–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã (–¥–ª—è MVP)
   - –ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

3. ‚úÖ **ChallengeManager** - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:
   - –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
   - –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–¥ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º

---

## –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏—é

**–í–ê–ñ–ù–û:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `join_challenge` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —É–±—Ä–∞–≤ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞.

### –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:

```sql
CREATE OR REPLACE FUNCTION join_challenge(
    p_user_id UUID,
    p_challenge_id BIGINT
)
RETURNS JSON AS $$
DECLARE
    v_challenge RECORD;
    v_user RECORD;
    v_user_challenge_id BIGINT;
    v_service_fee DECIMAL(10, 2);
BEGIN
    -- Get challenge
    SELECT * INTO v_challenge
    FROM public.challenges
    WHERE id = p_challenge_id AND is_active = true;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Challenge not found or inactive';
    END IF;
    
    -- Check if challenge has started
    IF v_challenge.start_date > NOW() THEN
        RAISE EXCEPTION 'Challenge has not started yet';
    END IF;
    
    -- Get user
    SELECT * INTO v_user
    FROM public.users
    WHERE id = p_user_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'User not found';
    END IF;
    
    -- Check if already joined
    IF EXISTS (
        SELECT 1 FROM public.user_challenges
        WHERE user_id = p_user_id AND challenge_id = p_challenge_id
    ) THEN
        RAISE EXCEPTION 'User already joined this challenge';
    END IF;
    
    -- –£–ë–†–ê–õ–ò –ü–†–û–í–ï–†–ö–£ –ë–ê–õ–ê–ù–°–ê - –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
    
    -- Calculate service fee
    v_service_fee := v_challenge.entry_fee * (v_challenge.service_fee_percent / 100.0);
    
    -- Start transaction
    BEGIN
        -- Create user challenge
        INSERT INTO public.user_challenges (user_id, challenge_id, is_active)
        VALUES (p_user_id, p_challenge_id, true)
        RETURNING id INTO v_user_challenge_id;
        
        -- Update challenge stats
        UPDATE public.challenges
        SET participants = participants + 1,
            prize_pool = prize_pool + (v_challenge.entry_fee - v_service_fee),
            active_participants = active_participants + 1,
            updated_at = NOW()
        WHERE id = p_challenge_id;
        
        -- –£–ë–†–ê–õ–ò –°–ü–ò–°–ê–ù–ò–ï –° –ë–ê–õ–ê–ù–°–ê - –æ–ø–ª–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞
        
        -- Create payment record (–ø–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º)
        INSERT INTO public.payments (
            user_id, challenge_id, type, status, amount,
            transaction_id, description
        ) VALUES (
            p_user_id, p_challenge_id, 'ENTRY_FEE', 'COMPLETED',
            v_challenge.entry_fee, gen_random_uuid()::TEXT,
            'Entry fee for challenge: ' || v_challenge.title
        );
        
        -- Return result
        RETURN json_build_object(
            'success', true,
            'user_challenge_id', v_user_challenge_id
        );
        
    EXCEPTION WHEN OTHERS THEN
        RAISE EXCEPTION 'Failed to join challenge: %', SQLERRM;
    END;
END;
$$ LANGUAGE plpgsql;
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª:**
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ChallengeAppBackend/supabase/update-join-challenge-function.sql`
- –í—Å—Ç–∞–≤—å—Ç–µ –≤ Supabase SQL Editor
- –ù–∞–∂–º–∏—Ç–µ **Run**

---

## –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

1. **–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (Cmd+B)
2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
3. **–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç**
4. **–û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π —á–µ–ª–ª–µ–Ω–¥–∂**
5. **–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –∑–∞ X ‚Ç¨"**
6. **–î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã** —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
7. **–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã** –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å"
8. **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã** –≤—ã –¥–æ–ª–∂–Ω—ã –≤—Å—Ç—É–ø–∏—Ç—å –≤ —á–µ–ª–ª–µ–Ω–¥–∂

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–µ–ª–ª–µ–Ω–¥–∂
2. –ù–∞–∂–∏–º–∞–µ—Ç **"–í–æ–π—Ç–∏ –∑–∞ 5 ‚Ç¨"**
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã —Å:
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ
   - –°—É–º–º–æ–π –∫ –æ–ø–ª–∞—Ç–µ
   - –ü—Ä–∞–≤–∏–ª–∞–º–∏
   - –í—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (Apple Pay / –ö–∞—Ä—Ç–∞)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ –Ω–∞–∂–∏–º–∞–µ—Ç **"–û–ø–ª–∞—Ç–∏—Ç—å"**
5. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ (—Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è MVP)
6. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —á–µ–ª–ª–µ–Ω–¥–∂
7. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`

---

## –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apple Pay:**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Merchant ID –≤ Apple Developer
   - –†–µ–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Apple Pay

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Stripe (–¥–ª—è –∫–∞—Ä—Ç):**
   - –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ Stripe
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Stripe SDK
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Stripe

3. **–í–µ–±—Ö—É–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π:**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä—è–º–æ–π –æ–ø–ª–∞—Ç—ã

‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –ø–ª–∞—Ç–∏—à—å –∏ –≤—Å—Ç—É–ø–∞–µ—à—å
‚úÖ **–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø–æ–ª–Ω—è—Ç—å –±–∞–ª–∞–Ω—Å** –∑–∞—Ä–∞–Ω–µ–µ
‚úÖ **–ú–µ–Ω—å—à–µ —à–∞–≥–æ–≤** –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úÖ **–ü—Ä–æ—â–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏** - –Ω–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤

---

## –ì–æ—Ç–æ–≤–æ! üéâ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—É—é –æ–ø–ª–∞—Ç—É –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ —á–µ–ª–ª–µ–Ω–¥–∂.
