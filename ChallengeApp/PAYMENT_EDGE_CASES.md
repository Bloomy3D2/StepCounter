# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases —Å –æ–ø–ª–∞—Ç–æ–π

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ edge cases

### 1. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã –¥–≤–∞–∂–¥—ã
- **–†–µ—à–µ–Ω–∏–µ:** –§–ª–∞–≥ `isPaymentInProgress` –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è
- **–ö–æ–¥:** `disabled(!agreedToTerms || paymentManager.isProcessing || isPaymentInProgress)`

### 2. ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –≤–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã
- **–†–µ—à–µ–Ω–∏–µ:** 
  - –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ (`onDisappear`)
  - –û—Ç–º–µ–Ω–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–û—Ç–º–µ–Ω–∞"
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `Task.isCancelled` –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã
- **–ö–æ–¥:** `paymentTask?.cancel()` –≤ `onDisappear` –∏ –∫–Ω–æ–ø–∫–µ "–û—Ç–º–µ–Ω–∞"

### 3. ‚úÖ –¢–∞–π–º–∞—É—Ç –æ–ø–ª–∞—Ç—ã
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞ –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è
- **–†–µ—à–µ–Ω–∏–µ:** –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ `withTimeout`
- **–ö–æ–¥:** `withTimeout(seconds: 30) { ... }`

### 4. ‚úÖ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `appState.currentUser?.id` –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."

### 5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç—É–ø–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π –∏ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —á–µ–ª–ª–µ–Ω–¥–∂–µ."

### 6. ‚úÖ –ß–µ–ª–µ–Ω–¥–∂ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç—É–ø–∏—Ç—å –¥–æ —Å—Ç–∞—Ä—Ç–∞
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `challenge.startDate > Date()`
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–ß–µ–ª–ª–µ–Ω–¥–∂ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å—Ç–∞—Ä—Ç–∞."

### 7. ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–ª—É—á–∞–π: –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
- **–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–Ω—ã, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—Å—Ç—É–ø–∏–ª –≤ —á–µ–ª–ª–µ–Ω–¥–∂
- **–†–µ—à–µ–Ω–∏–µ:** 
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
  - –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - –£–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—É–ø–∏—Ç—å –≤ —á–µ–ª–ª–µ–Ω–¥–∂. –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."

### 8. ‚úÖ –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω—É–ª–∞ –æ—à–∏–±–∫—É
- **–†–µ—à–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `PaymentManager` —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- **–ö–æ–¥:** `catch` –±–ª–æ–∫–∏ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `lastError`

### 9. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `amount > 0` –≤ `PaymentManager`
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞"

### 10. ‚úÖ –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
- **–†–µ—à–µ–Ω–∏–µ:** –¢–∞–π–º–∞—É—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `PaymentManager`
- **–°–æ–æ–±—â–µ–Ω–∏–µ:** "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."

---

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

### 1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–æ–π–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –∏–∑-–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º

**–†–µ—à–µ–Ω–∏–µ:**
```swift
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
let transactionId = UUID().uuidString

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
UserDefaults.standard.set(transactionId, forKey: "pending_payment_\(challenge.id)")

// –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
// –ü—Ä–∏ –æ—à–∏–±–∫–µ - –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å —Ç–µ–º –∂–µ transactionId
```

### 2. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å

**–†–µ—à–µ–Ω–∏–µ:**
```swift
// –í Edge Function –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
func refundPayment(transactionId: String, userId: String, amount: Double) async throws {
    // –í—ã–∑–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–ª—É—á–∞–∏ "–æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"

**–†–µ—à–µ–Ω–∏–µ:**
```swift
// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Sentry, Firebase Crashlytics)
Logger.shared.logCritical(
    "Payment succeeded but join failed",
    metadata: [
        "userId": userId,
        "challengeId": challenge.id,
        "transactionId": transactionId,
        "error": error.localizedDescription
    ]
)
```

### 4. Retry –º–µ—Ö–∞–Ω–∏–∑–º
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```swift
func processPaymentWithRetry(maxRetries: Int = 3) async -> Bool {
    for attempt in 1...maxRetries {
        if let result = await processPayment() {
            return result
        }
        if attempt < maxRetries {
            try? await Task.sleep(nanoseconds: UInt64(attempt) * 1_000_000_000)
        }
    }
    return false
}
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—è—Å–Ω–æ, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂

**–†–µ—à–µ–Ω–∏–µ:**
```swift
// –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫ –∏–ª–∏ API
func verifyPaymentStatus(transactionId: String) async -> PaymentStatus {
    // –ó–∞–ø—Ä–æ—Å –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    // –í–æ–∑–≤—Ä–∞—Ç: .pending, .completed, .failed, .refunded
}
```

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ edge cases

### –ü–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π:
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
- [x] –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

### –í–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã:
- [x] –¢–∞–π–º–∞—É—Ç (30 —Å–µ–∫—É–Ω–¥)
- [x] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É –∑–∞–¥–∞—á–∏

### –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [x] –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞):
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [ ] Retry –º–µ—Ö–∞–Ω–∏–∑–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

---

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
2. –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
3. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "already joined")

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚ö†Ô∏è **–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
2. –ù–∞–∂–∏–º–∞–µ—Ç –µ—â–µ —Ä–∞–∑ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
- ‚úÖ –§–ª–∞–≥ `isPaymentInProgress` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ó–∞–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–ø–ª–∞—Ç—É
2. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- ‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (`paymentTask?.cancel()`)
- ‚úÖ –ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- ‚ö†Ô∏è **–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:** –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø–ª–∞—Ç–µ–∂–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –¢–∞–π–º–∞—É—Ç –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–ø–ª–∞—Ç—É
2. –ü–ª–∞—Ç–µ–∂ –∑–∞–≤–∏—Å–∞–µ—Ç –±–æ–ª–µ–µ 30 —Å–µ–∫—É–Ω–¥

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
- ‚úÖ –¢–∞–π–º–∞—É—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è"
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞

---

## ‚úÖ –ò—Ç–æ–≥

**–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
- ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–ª—É—á–∞–π "–æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- ‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- ‚ö†Ô∏è –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π
- ‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è Retry –º–µ—Ö–∞–Ω–∏–∑–º
