# üìç –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –º–∞—Ä—à—Ä—É—Ç–∞

**–°–ø–æ—Å–æ–± 1: –ò–∑ —ç–∫—Ä–∞–Ω–∞ "–ú–∞—Ä—à—Ä—É—Ç—ã"**
```swift
// –í RoutesView.swift
Button("–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç") {
    locationManager.startTracking()
    showMapView = true
}
```

**–°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ**
```swift
locationManager.startTracking()
```

### 2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç

**–°–ø–æ—Å–æ–± 1: –ò–∑ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞**
- –û—Ç–∫—Ä–æ–π—Ç–µ `RouteMapView` (–∫–∞—Ä—Ç–∞ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º)
- –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–ó–∞–≤–µ—Ä—à–∏—Ç—å"** –∏–ª–∏ **"–°—Ç–æ–ø"**
- –ú–∞—Ä—à—Ä—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è

**–°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ**
```swift
locationManager.stopTracking()
```

---

## ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

–ú–∞—Ä—à—Ä—É—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `stopTracking()`, –µ—Å–ª–∏:

1. ‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç **–±–æ–ª–µ–µ 1 —Ç–æ—á–∫–∏**
2. ‚úÖ –î–∏—Å—Ç–∞–Ω—Ü–∏—è **–±–æ–ª–µ–µ 50 –º–µ—Ç—Ä–æ–≤**
3. ‚úÖ –ï—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–º. –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∏–∂–µ)

### –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤ `LocationManager.swift`):

```swift
func stopTracking() {
    locationManager.stopUpdatingLocation()
    isTracking = false
    
    if var route = currentRoute {
        route.endDate = Date()
        route.duration = Date().timeIntervalSince(trackingStartTime ?? Date())
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if route.points.count > 1 && route.distance > 50 {
            savedRoutes.insert(route, at: 0)  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            saveRoutes()  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ UserDefaults
        }
    }
    
    currentRoute = nil
}
```

---

## üíæ –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –º–∞—Ä—à—Ä—É—Ç—ã

### –•—Ä–∞–Ω–µ–Ω–∏–µ:
- **UserDefaults** —Å –∫–ª—é—á–æ–º `"savedRoutes"`
- –§–æ—Ä–º–∞—Ç: JSON (–º–∞—Å—Å–∏–≤ `RecordedRoute`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
```swift
private func saveRoutes() {
    let routesToSave = Array(savedRoutes.prefix(maxRoutes))
    if let data = try? JSONEncoder().encode(routesToSave) {
        UserDefaults.standard.set(data, forKey: "savedRoutes")
    }
}
```

---

## üìä –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- ‚ö†Ô∏è **–ú–∞–∫—Å–∏–º—É–º 5 –º–∞—Ä—à—Ä—É—Ç–æ–≤**
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç

### Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- ‚úÖ **–î–æ 1000 –º–∞—Ä—à—Ä—É—Ç–æ–≤** (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ:
```swift
let subscriptionManager = SubscriptionManager.shared
let hasUnlimitedRoutes = subscriptionManager.hasAccess(to: .unlimitedRoutes)

let maxRoutes = hasUnlimitedRoutes ? 1000 : 5
```

---

## üéØ –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
```swift
locationManager.startTracking()
// –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π RecordedRoute
// –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–±–æ—Ä —Ç–æ—á–µ–∫ —á–µ—Ä–µ–∑ CLLocationManager
```

### –®–∞–≥ 2: –ó–∞–ø–∏—Å—å —Ç–æ—á–µ–∫
```swift
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–æ–∫–∞—Ü–∏–∏:
// - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è RoutePoint –≤ currentRoute.points
// - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è distance
// - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è currentRoute
```

### –®–∞–≥ 3: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
```swift
locationManager.stopTracking()
// - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è endDate
// - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è duration
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å (points > 1, distance > 50)
// - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ savedRoutes
// - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è saveRoutes()
```

### –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ UserDefaults
```swift
saveRoutes()
// - –ö–æ–¥–∏—Ä—É–µ—Ç—Å—è –≤ JSON
// - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ UserDefaults
```

---

## üì± –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ UI

### –í RouteMapView:

```swift
Button {
    locationManager.stopTracking()
    dismiss()
} label: {
    HStack {
        Image(systemName: "stop.circle.fill")
        Text("–ó–∞–≤–µ—Ä—à–∏—Ç—å")
    }
    .foregroundColor(.white)
    .padding()
    .background(Color.red)
    .cornerRadius(12)
}
```

### –í RoutesView:

```swift
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
if locationManager.isTracking {
    currentRouteCard  // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
} else {
    startRouteButton  // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç"
}
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã:
```swift
let allRoutes = locationManager.savedRoutes
```

### –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞ –Ω–µ–¥–µ–ª—é:
```swift
let weeklyRoutes = locationManager.routesThisWeek
```

### –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞ –º–µ—Å—è—Ü:
```swift
let monthlyRoutes = locationManager.routesThisMonth
```

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
```swift
let totalDistance = locationManager.totalDistance  // –í –º–µ—Ç—Ä–∞—Ö
let totalDuration = locationManager.totalDuration  // –í —Å–µ–∫—É–Ω–¥–∞—Ö
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- ‚úÖ –ï—Å—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏
- ‚úÖ –î–∏—Å—Ç–∞–Ω—Ü–∏—è > 50 –º–µ—Ç—Ä–æ–≤

### 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
```swift
// –í locationManager(_:didUpdateLocations:)
guard location.horizontalAccuracy < 50 else { return }
// –¢–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (< 50 –º–µ—Ç—Ä–æ–≤ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏)
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –¥–ª—è free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –£–¥–∞–ª—è–µ—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç
- –ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞

---

## üõ†Ô∏è –†—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤—Ä—É—á–Ω—É—é:

```swift
if var route = locationManager.currentRoute {
    route.endDate = Date()
    route.duration = Date().timeIntervalSince(route.startDate)
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
    if route.points.count > 1 && route.distance > 50 {
        locationManager.savedRoutes.insert(route, at: 0)
        // saveRoutes() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ savedRoutes
    }
}
```

---

## üìñ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **`LocationManager.swift`** ‚Äî –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
- **`RoutesView.swift`** ‚Äî —ç–∫—Ä–∞–Ω —Å–æ —Å–ø–∏—Å–∫–æ–º –º–∞—Ä—à—Ä—É—Ç–æ–≤
- **`RouteMapView.swift`** ‚Äî –∫–∞—Ä—Ç–∞ —Å –∑–∞–ø–∏—Å—å—é –º–∞—Ä—à—Ä—É—Ç–∞
- **`RecordedRoute.swift`** ‚Äî –º–æ–¥–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ (–≤ `LocationManager.swift`)

---

## ‚úÖ –ò—Ç–æ–≥

**–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `stopTracking()`, –µ—Å–ª–∏ –æ–Ω –≤–∞–ª–∏–¥–µ–Ω. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è! üéâ
